<!DOCTYPE html>
<html lang="en" xmlns:fb="http://www.facebook.com/2008/fbml">
  <head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Erlocator</title>
	<meta name="description" content="Erlocator." />
	<meta name="author" content="Erlocator Client">

	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="bootstrap.min.css" rel="stylesheet"/>
        <link href="bootstrap-responsive.min.css" rel="stylesheet"/>
	<link rel="shortcut icon" href="/favicon.ico" />
        <script type="text/javascript" src="https://getfirebug.com/firebug-lite-debug.js">{
            overrideConsole: false,
            startOpened: false
        }</script>
</head>
<body>
<style>

    html, body {
        height: 100%;
    }
    .wrapper {
        min-height: 100%;
        height: auto !important;
        height: 100%;
        margin: 0 auto -63px;
    }
    #clientform{
        z-index: 1000;
        border-radius: 5px;
        position:absolute;
        top:10px;
        right :20px;
        width:220px;
        padding:20px;
        float:right;
        background : #ddd;
        -moz-box-shadow: 10px 10px 5px #888;
        -webkit-box-shadow: 10px 10px 5px #888;
        box-shadow: 10px 10px 5px #888;
    }
    #clientform button{
        margin:5px;
    }
    .mapwrap{
        position: relative;
        margin: 20px;
        width : 98.2%;
        height : 600px;
        border: 1px solid blue;
    }
    #googlemap{
        width : 100%;
        height : 100%;
    }
    #googlemap img {
        max-width: none;
    }
    #genneighbors {
        width: 200px;
    }
    #numneighbors {
        width: 200px;
        margin-left: 5px;
        background: url("") repeat-x scroll 50% 50% #FFFFFF;
        border: 1px solid #AAAAAA;
        color: #222222;
        height: 0.8em;
        position: relative;
        text-align: left;
    }
    #numneighbors div{
        position: relative;
        width: 182px;
    }
    .map_info {
    	width : 280px;
    	height: 60px;
    	background: white;
    }
    .map_info div{
    	width : 200px;
    	height: 30px;
    	float: left;
    }
    .map_info div p{
    	line-height: 30px;
     	vertical-align: middle;
    }
    .map_info .profileimg{
    	width:50px;
    	height:50px;
    	margin:5px;
    	float:left;
    }
    .ui-state-default, .ui-widget-content .ui-state-default, .ui-widget-header .ui-state-default {
        background: repeat-x scroll 50% 50% #51a351;
        border: 1px solid #D3D3D3;
        color: #51a351;
        font-weight: normal;
    }
    .ui-slider-horizontal .ui-slider-handle {
        top: -0.3em;
    }
    .ui-slider .ui-slider-handle {
        cursor: default;
        height: 1.2em;
        position: absolute;
        width: 1.2em;
        z-index: 2;
    }
    .ui-widget-content a {
        color: #51a351;
    }
    .ui-corner-all {
        border-radius: 4px;
    }
</style>
<script>
window.fbAsyncInit = function() {
    FB.init({
      appId      : '592913787405415', // App ID
      channelUrl : '//erlocator.org/geonum/demo/fb-channel.html', // Channel File
      status     : true, // check login status
      cookie     : true, // enable cookies to allow the server to access the session
      xfbml      : true  // parse XFBML
    });
    // Additional init code here
};

// Load the SDK Asynchronously
(function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
}(document));

function fblogin() {
    FB.login(function(response) {
        if (response.authResponse) {
            // connected - get user information
            FB.api('/me', function(response) {
                $("#first_name").attr("value", response.name);
                $("#profile_link").attr("value", "//facebook.com/" + response.id);
                $("#avatar").attr("value", "//graph.facebook.com/" + response.id + "/picture");
                client.facebookid = response.id;
                client.name = response.name;
                client.profileURL = "//facebook.com/" + response.id;
                client.imageURL = "//graph.facebook.com/" + response.id + "/picture";
                addClient();
        		placeMarker(client,true);
            });
        } else {
            // cancelled - do nothing
        }
    });
}
</script>
 <div class="wrapper">
<div class="container">
<header>
<h1>Erlocator Demo</h1>
</header>
</div>
<div class="row">
    <div class="span12 mapwrap">
        <div id="googlemap"></div>
        <div id="clientform" class="rounded_corners">
            <a id="facebooklogin"><img src="login-facebook.png"/></a>
            <label>Name</label><input id="name" type="text" value="guest"/>
            <label>Image</label><input id="avatar" type="text" value="http://erlocator.org/geonum/demo/defaultsmall.gif"/>
            <label>Profile URL</label><input id="profile_link" type="text" value="http://erlocator.org/geonum/demo/index.html"/>
            <button id="updateinfo" class="btn btn-info">Update Info</button>
            <button id="neighbors" class="btn btn-info">Get Neighbors</button>
            <button id="boundingbox" class="btn btn-info">Get Bounding Box</button>
            <hr>
            <button id="genneighbors" class="btn btn-success">Generate <span>1</span> Neighbor(s)</button>
            <div id="numneighbors"><div></div></div>
            <hr>
            <button id="clearmap" class="btn btn-warning">Clear Map</button>

        </div>
    </div>
</div>
</div>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.3/jquery-ui.min.js"></script>
<script type="text/javascript" src="//maps.googleapis.com/maps/api/js?key=AIzaSyBKDimjznrPHNMwq4H0hJ036LzP_UFpbdo&amp;sensor=true&amp;libraries=geometry"></script>
<script type="text/javascript" src="infobox.js"></script>


<script>
//identifier for the user
var host = "http://erlocator.org/";
var client = {
    geonum : "",
    id : Math.floor((Math.random()*10000)+1).toString(),
    facebookid : 0,
    name : "guest",
    lat : 40,
    lon : -75,
    profileURL : "http://erlocator.org/geonum/demo/index.html",
    imageURL : "http://erlocator.org/geonum/demo/defaultsmall.gif"
};
 var data = {
    geocoder : "",
    boundingbox : "",
    map : "",
    clientinfo : "",
    arrCurrentMarkers : []
};
$(document).ready(function(){
    if(typeof(google)!=='undefined'){
            var mapOptions = {
                width: 744,
                zoom: 2,
                minZoom: 2,
                disableDefaultUI: true,
                zoomControl: true,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            data.map = new google.maps.Map(document.getElementById('googlemap'),
                    mapOptions);
            data.map.setCenter(new google.maps.LatLng(client.lat,client.lon));
            data.map.setZoom(11);
    }

    placeMarker(client,true);
    if(navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
              client.lat = position.coords.latitude;
              client.lon = position.coords.longitude;
              addClient();
              if(data.map){
                  data.map.setCenter(new google.maps.LatLng(client.lat ,client.lon));
                  placeMarker(client,true);
              }
        }, function() {

        }, {maximumAge:30000, timeout: 2000});
    } else {
        // Browser doesn't support Geolocation
    }

    $('#facebooklogin').click(function(){
        fblogin();
    });

    $('#neighbors').click(function(){
        getNeighbors();
    });

    $('#genneighbors').click(function(){
        generateNeighbors();
    });

    $("#numneighbors div").slider({
        range: "max",
        min: 1,
        max: 100,
        value: 1,
        slide: function( event, ui ) {
            $( "#genneighbors span" ).text( ui.value );
        }
    });

    $('#clearmap').click(function(){
        clearMap();
    });

    $('#boundingbox').click(function(){
        if( $('#boundingbox').text()=="Get Bounding Box"){
            getBoundingBox();
            $('#boundingbox').text("Clear Bounding Box");
        }else{
            if(data.bounding_box)data.bounding_box.setMap(null);
            $('#boundingbox').text("Get Bounding Box");
        }
    });
    $('#updateinfo').click(function(){
        client.name = $('#name').val();
        if(/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test($('#avatar').val())) {
        	client.imageURL = $('#avatar').val();
        }else{
        	$('#avatar').val(client.imageURL);
        }
        if(/^([a-z]([a-z]|\d|\+|-|\.)*):(\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?((\[(|(v[\da-f]{1,}\.(([a-z]|\d|-|\.|_|~)|[!\$&'\(\)\*\+,;=]|:)+))\])|((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=])*)(:\d*)?)(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*|(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)|((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)){0})(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test($('#profile_link').val())) {
        	client.profileURL = $('#profile_link').val();
        }else{
		    $('#profile_link').val(client.profileURL);
        }
        addClient();
        placeMarker(client,true);
    });
    $('#name').val(client.name);
});

function getNeighbors(){
    $.getJSON(host+'geo/neighbors',"geonum="+client.geonum,function(response){
        /*
         {"neighbors":[{"geonum":62914559,"id":"1501","lat":"90","lon":"90"},{"geonum":62914558,"id":"1502","lat":"90","lon":"90"}]}
         */
         //clearMap();
         $.each(response.neighbors, function(index, neighbor) {
             if(neighbor.id != client.id){
                if(typeof(neighbor.name) == "undefined")neighbor.name = "Neighbor";
                if(typeof(neighbor.imageURL) == "undefined")neighbor.imageURL = "http://erlocator.org/geonum/demo/defaultsmall.gif";
                if(typeof(neighbor.profileURL) == "undefined")neighbor.profileURL = "http://erlocator.org/geonum/demo/index.html";
                placeMarker(neighbor);
             }
         });
    });
}

function generateNeighbors(){
    //
    $.post(host+'geo/generate',{geonum:client.geonum,n: $( "#numneighbors div" ).slider( "value" )},
        function(obj) {
           getNeighbors();
        }
    );
}

function getBoundingBox(){
    $.getJSON(host+'geo/bbox',"geonum="+client.geonum,function(response){
        /*
         {"top_left":{"lat":90.0,"lon":89.9560546875},"bottom_right":{"lat":89.9560546875,"lon":90.0}}
         */
        //draw bounding box
        var tleft = response.bbox_3x3.top_left;
        var bright = response.bbox_3x3.bottom_right;
        var bound = new google.maps.LatLngBounds();
        bound.extend(new google.maps.LatLng(tleft.lat,tleft.lon));
        bound.extend(new google.maps.LatLng(bright.lat,bright.lon));

        ne = bound.getNorthEast();
        sw = bound.getSouthWest();
        se = new google.maps.LatLng(sw.lat(),ne.lng());
        nw = new google.maps.LatLng(ne.lat(),sw.lng());
        map_c = new google.maps.LatLng(ne.lat(),-180);
        map_ne = new google.maps.LatLng(74,-180);
        map_sw =  new google.maps.LatLng(-90,180);
        map_se1 = new google.maps.LatLng(map_sw.lat(),0);
        map_se2 = new google.maps.LatLng(map_sw.lat(),-180);
        map_nw = new google.maps.LatLng(map_ne.lat(),map_sw.lng());
        if(data.bounding_box)data.bounding_box.setMap(null);
        data.bounding_box = new google.maps.Polygon({
        paths: [ne,se,sw,nw,map_ne,map_se2,map_se1,map_sw,map_c,ne],
                  strokeColor: "blue",
                  strokeOpacity: 0.8,
                  strokeWeight: 0,
                  fillColor: "blue",
                  fillOpacity: 0.15,
                  map: data.map
        });
    });
}

function addClient(){
    //at a a minimum id, lat, lon must be provided
    $.post(host+'geo/set',client,
        function(obj) {
            var response = $.parseJSON(obj);
            client.geonum = obj.geonum;
        }
    );
}

function placeMarker(obj,draggable){
    //make sure we are not leaving duplicate markers
    if(data.arrCurrentMarkers["m"+obj.id]){data.arrCurrentMarkers["m"+obj.id].setMap(null);}
    var el = '<div class="map_info">';
    var userFullName = obj.name;
    if (userFullName.length > 20) {
            userFullName = userFullName.substr(0, 20) + '...';
    }
	el += '<img class="profileimg" src="'+obj.imageURL+'"/>';
	el += '<div><p>'+userFullName+'</p></div>';
	el += '<span class="links">';
	el += '<a target="_blank" href="'+obj.profileURL+'">Profile ';
	if(typeof(obj.facebookid) != "undefined" && obj.facebookid != 0)el += ' <img class="fbimg" src="shout_facebook.png" alt="Facebook">';
	el += '</a>';
	el += '</div>';
	var infowindow = new InfoBox({
		disableAutoPan: false,
		maxWidth: 150,
		zIndex: null,
		boxStyle: {
			opacity: 1,
			width: "280px"
		},
		closeBoxMargin: "12px 4px 2px 2px",
		closeBoxURL: "http://www.google.com/intl/en_us/mapfiles/close.gif",
		infoBoxClearance: new google.maps.Size(1, 1),
		content: el
	});

    if(draggable){
        //Client
        var marker = new google.maps.Marker({
            icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            draggable: true,
            position: new google.maps.LatLng(obj.lat, obj.lon),
            map: data.map
         });
         //show the infowindow with the new data
         data.clientinfo = infowindow;
         data.clientinfo.open(data.map,marker);
         setTimeout(function () { data.clientinfo.close(); }, 2000);
         google.maps.event.addListener(marker, 'dragend', function() {
             if(data.clientinfo)data.clientinfo.close();
              var pos = marker.getPosition();
              client.lat = pos.lat();
              client.lon = pos.lng();
              addClient();
              if(data.bounding_box)data.bounding_box.setMap(null);
        });
    }else{
        //Neighbor
       var marker = new google.maps.Marker({
        position: new google.maps.LatLng(obj.lat, obj.lon),
        map: data.map
       });
    }
    google.maps.event.addListener(marker, 'click', function() {
        infowindow.open(data.map,marker);
        setTimeout(function () { infowindow.close(); }, 10000);
    });

    data.arrCurrentMarkers["m"+obj.id] = marker; //Add Marker to array
}

function removeClient(id){
    $.post(host+'geo/delete','id='+id,
        function(response) {
            removeMaker(response);
        }
    );
}

function removeMarker (obj) {
     if(data.arrCurrentMarkers["m"+obj.id]){
        data.arrCurrentMarkers["m"+obj.id].setMap(null);
        delete 	data.arrCurrentMarkers["m"+obj.id];
     }
}

function clearMap() {
    for(var key in data.arrCurrentMarkers){
            data.arrCurrentMarkers[key].setMap(null);
            delete data.arrCurrentMarkers[key];
    }
    placeMarker(client,true);
}//end clearMap

window.onbeforeunload = function() {
  removeClient(client.id);
}
</script>
</body>
</html>
